{% extends 'base.html' %}
{% load static %}
{% load editorjs_tags %}

{% block title %}Essay{% endblock %}

{% block extra_head %}
<style>
    /* 카테고리 사이드바 */
    .category-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .category-list li a {
        display: block;
        padding: 9px 14px;
        color: #555;
        text-decoration: none;
        font-size: 0.92rem;
        border-radius: 6px;
        transition: all 0.15s;
    }
    .category-list li a:hover {
        background: #f0f0f0;
        color: #111;
    }
    .category-list li a.active {
        background: #333;
        color: #fff;
        font-weight: 600;
    }
    .category-title {
        font-size: 1rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 14px;
        padding-bottom: 10px;
        border-bottom: 2px solid #333;
    }

    /* 글 카드 */
    .post-card {
        display: flex;
        gap: 20px;
        padding: 20px 0;
        border-bottom: 1px solid #eee;
        text-decoration: none;
        color: inherit;
        transition: background 0.15s;
    }
    .post-card:hover {
        background: #fafafa;
    }
    .post-card-body {
        flex: 1;
        min-width: 0;
    }
    .post-card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 6px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .post-card-date {
        font-size: 0.8rem;
        color: #999;
        margin-bottom: 8px;
    }
    .post-card-summary {
        font-size: 0.9rem;
        color: #666;
        line-height: 1.6;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .post-card-thumb {
        flex-shrink: 0;
        width: 140px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        background: #f0f0f0;
    }
    .post-card-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* 페이지네이션 */
    .pagination .page-link {
        color: #333;
        border-color: #ddd;
        font-size: 0.9rem;
    }
    .pagination .page-item.active .page-link {
        background: #333;
        border-color: #333;
        color: #fff;
    }

    /* 빈 상태 */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #aaa;
    }
    .empty-state .material-icons-outlined {
        font-size: 48px;
        margin-bottom: 12px;
    }

    /* 검색 */
    .search-input-wrap {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px 12px;
        background: #fff;
        transition: border-color 0.2s;
    }
    .search-input-wrap:focus-within {
        border-color: #333;
    }
    .search-icon {
        font-size: 20px;
        color: #999;
        margin-right: 8px;
    }
    .search-input {
        border: none;
        outline: none;
        font-size: 0.9rem;
        width: 100%;
        background: transparent;
    }

    @media (max-width: 576px) {
        .post-card-thumb {
            width: 100px;
            height: 72px;
        }
    }
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row">
    <!-- 사이드바 -->
    <div class="col-md-3">
        <!-- 검색 -->
        <div class="search-box mb-4">
            <form method="get" action="{% url 'essay' %}">
                {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
                <div class="search-input-wrap">
                    <span class="material-icons-outlined search-icon">search</span>
                    <input type="text" name="q" value="{{ query }}" placeholder="검색어를 입력하세요" class="search-input">
                </div>
            </form>
        </div>

        <!-- 카테고리 -->
        <div class="category-title">카테고리</div>
        <ul class="category-list">
            <li><a href="{% url 'essay' %}" class="{% if not current_category %}active{% endif %}">전체</a></li>
            {% for cat in categories %}
            <li><a href="{% url 'essay' %}?category={{ cat.id }}" class="{% if current_category == cat.id %}active{% endif %}">{{ cat.name }}</a></li>
            {% endfor %}
        </ul>
    </div>

    <!-- 글 목록 -->
    <div class="col-md-9">
        <h4 class="mb-3" style="font-weight:700;">
            {% if query %}
                "{{ query }}" 검색 결과
            {% elif current_category %}
                {% for cat in categories %}
                    {% if cat.id == current_category %}{{ cat.name }}{% endif %}
                {% endfor %}
            {% else %}
                전체 글
            {% endif %}
        </h4>

        {% if posts %}
            {% for post in posts %}
            <a href="{% url 'essay_detail' post.pk %}" class="post-card">
                <div class="post-card-body">
                    <div class="post-card-title">{{ post.title }}</div>
                    <div class="post-card-date">{{ post.created_at|date:"Y.m.d" }}</div>
                    <div class="post-card-summary">{{ post.content|editorjs_plaintext|truncatechars:120 }}</div>
                </div>
                {% if post.thumbnail %}
                <div class="post-card-thumb">
                    <img src="{{ post.thumbnail.url }}" alt="{{ post.title }}">
                </div>
                {% endif %}
            </a>
            {% endfor %}

            <!-- 페이지네이션 -->
            {% if posts.has_other_pages %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if posts.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if current_category %}category={{ current_category }}&{% endif %}{% if query %}q={{ query }}&{% endif %}page={{ posts.previous_page_number }}">이전</a>
                    </li>
                    {% endif %}

                    {% for num in posts.paginator.page_range %}
                        {% if posts.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if current_category %}category={{ current_category }}&{% endif %}{% if query %}q={{ query }}&{% endif %}page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if posts.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if current_category %}category={{ current_category }}&{% endif %}{% if query %}q={{ query }}&{% endif %}page={{ posts.next_page_number }}">다음</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <span class="material-icons-outlined">article</span>
                <p>아직 작성된 글이 없습니다.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
