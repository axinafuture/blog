{% extends 'base.html' %}
{% load static %}
{% load editorjs_tags %}

{% block title %}에세이{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/essay.css' %}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row">
    <!-- 사이드바 -->
    <div class="col-md-3">
        <!-- 검색 -->
        <div class="search-box mb-4">
            <form method="get" action="{% url 'essay' %}">
                {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
                <div class="essay-search-wrap">
                    <span class="material-icons-outlined essay-search-icon">search</span>
                    <input type="text" name="q" value="{{ query }}" placeholder="검색어를 입력하세요" class="essay-search-input">
                </div>
            </form>
        </div>

        <!-- 카테고리 -->
        <div class="essay-category-title">카테고리</div>
        <ul class="essay-category-list">
            <li><a href="{% url 'essay' %}" class="{% if not current_category %}active{% endif %}">전체</a></li>
            {% for cat in categories %}
            <li><a href="{% url 'essay' %}?category={{ cat.id }}" class="{% if current_category == cat.id %}active{% endif %}">{{ cat.name }}</a></li>
            {% endfor %}
        </ul>
    </div>

    <!-- 글 목록 -->
    <div class="col-md-9">
        <h4 class="mb-3 essay-page-title">
            {% if query %}
                "{{ query }}" 검색 결과
            {% elif current_category %}
                {% for cat in categories %}
                    {% if cat.id == current_category %}{{ cat.name }}{% endif %}
                {% endfor %}
            {% else %}
                전체 글
            {% endif %}
        </h4>

        {% if posts %}
            {% for post in posts %}
            <a href="{% url 'essay_detail' post.pk %}" class="essay-post-card">
                <div class="essay-post-card-body">
                    <div class="essay-post-card-title">{{ post.title }}</div>
                    <div class="essay-post-card-date">{{ post.created_at|date:"Y.m.d" }}</div>
                    <div class="essay-post-card-summary">{{ post.content|editorjs_plaintext|truncatechars:120 }}</div>
                </div>
                {% if post.thumbnail %}
                <div class="essay-post-card-thumb">
                    <img src="{{ post.thumbnail.url }}" alt="{{ post.title }}">
                </div>
                {% endif %}
            </a>
            {% endfor %}

            <!-- 페이지네이션 -->
            {% if posts.has_other_pages %}
            <nav class="mt-4">
                <ul class="pagination essay-pagination justify-content-center">
                    {% if posts.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if current_category %}category={{ current_category }}&{% endif %}{% if query %}q={{ query }}&{% endif %}page={{ posts.previous_page_number }}">이전</a>
                    </li>
                    {% endif %}

                    {% for num in posts.paginator.page_range %}
                        {% if posts.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if current_category %}category={{ current_category }}&{% endif %}{% if query %}q={{ query }}&{% endif %}page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if posts.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if current_category %}category={{ current_category }}&{% endif %}{% if query %}q={{ query }}&{% endif %}page={{ posts.next_page_number }}">다음</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="essay-empty-state">
                <span class="material-icons-outlined">article</span>
                <p>아직 작성된 글이 없습니다.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
